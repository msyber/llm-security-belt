<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>A 20-minute LLM Security Belt — Live Demo</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    /* Neutrals */
    --bg:#0b0d10; --fg:#e8edf2; --muted:#c9d2db; --card:#11161c; --line:#2a3644;
    /* Accents (Google/Apple/AWS-ish) */
    --blue:#2563eb;     /* URL/Network  (LLM01) */
    --purple:#7c3aed;   /* Tools/Agency (LLM06) */
    --teal:#14b8a6;     /* JSON/Structure (LLM05) */
    --amber:#f59e0b;    /* Limits/Cost  (LLM10) */
    --accent:#3ea0ff;
    --danger:#ef4444; --ok:#10b981; --focus:#f59e0b; --radius:16px;

    /* Soft gradient for hero & CTA */
    --grad: linear-gradient(90deg, var(--purple), var(--blue), var(--teal));
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f9fc; --fg:#0b0d10; --muted:#334155; --card:#ffffff; --line:#d6dee7;
      --blue:#1d4ed8; --purple:#6d28d9; --teal:#0d9488; --amber:#d97706; --accent:#1d4ed8;
    }
  }

  *{ box-sizing:border-box } html{ font-size:18px }
  body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; line-height:1.5; color:var(--fg); background:var(--bg) }
  a{ color:var(--accent); text-decoration:none }

  /* Glassy header + accent bar */
  header{
    padding:1.1rem 0 1.25rem;
    border-bottom:1px solid var(--line);
    position:sticky; top:0;
    backdrop-filter: blur(8px);
    background: color-mix(in srgb, var(--bg) 88%, transparent);
  }
  .accentbar{ height:3px; width:100%; background:var(--grad); border-radius:0 0 999px 999px; }

  /* Layout */
  .wrap{ max-width:70rem; margin:0 auto; padding:0 1rem }
  h1{ margin:.25rem 0; font-size:1.8rem }
  .gradtext{ background: var(--grad); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color: transparent; }
  p.sub{ margin:0; color:var(--muted) }

  /* Chips row (scrollable on mobile) */
  .chips{ display:flex; gap:.5rem; margin-top:.6rem; overflow:auto; padding-bottom:.2rem; scrollbar-width:none; -ms-overflow-style:none; }
  .chips::-webkit-scrollbar{ display:none; }
  .chip{ font-size:.78rem; padding:.35rem .6rem; border:1px solid var(--line); border-radius:999px; color:var(--muted); background: color-mix(in srgb, var(--card) 70%, transparent) }
  .chip--blue   { border-color: color-mix(in srgb, var(--blue) 45%, var(--line));   color:var(--blue) }
  .chip--purple { border-color: color-mix(in srgb, var(--purple) 45%, var(--line)); color:var(--purple) }
  .chip--teal   { border-color: color-mix(in srgb, var(--teal) 45%, var(--line));   color:var(--teal) }
  .chip--amber  { border-color: color-mix(in srgb, var(--amber) 45%, var(--line));  color:var(--amber) }

  /* Cards & grids */
  main{ padding:1rem 0 2rem } .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:1rem }
  .kpis{ display:grid; gap:1rem; grid-template-columns:repeat(4,1fr) } @media (max-width:52rem){ .kpis{ grid-template-columns:repeat(2,1fr) } }
  .grid{ display:grid; gap:1rem; grid-template-columns:1.1fr 1fr } @media (max-width:64rem){ .grid{ grid-template-columns:1fr } }
  .kpi{ text-align:center; padding:1rem; border-radius:12px; border:1px solid var(--line) } .kpi h3{ margin:0 0 .25rem; font-size:.9rem; color:var(--muted) }
  .kpi .num{ font-size:1.6rem; font-weight:800; letter-spacing:.2px } .kpi.ok .num{ color:var(--ok) } .kpi.bad .num{ color:var(--danger) }
  textarea{ width:100%; min-height:9rem; color:var(--fg); background: color-mix(in srgb, var(--card) 70%, transparent); border:1px solid var(--line); border-radius:12px; padding:.75rem }
  .controls{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap } label{ font-weight:600 }

  /* Buttons */
  button{ appearance:none; border:2px solid var(--accent); color:var(--fg); background:transparent; padding:.6rem .9rem; border-radius:.75rem; font-weight:700; cursor:pointer }
  button.primary{ background:var(--grad); border:0; color:#fff; box-shadow:0 6px 16px color-mix(in srgb, var(--blue) 25%, transparent) }
  button.primary:hover{ filter:brightness(1.05) }
  button.ghost{ border-color:var(--line); color:var(--muted) }
  button:focus-visible, input:focus-visible, textarea:focus-visible{ outline:3px solid var(--focus); outline-offset:2px }

  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;font-weight:700;border:1px solid transparent}
  .badge.ok{background:#10b98122;border-color:#10b98155} .badge.block{background:#ef444422;border-color:#ef444455}
  .events{ max-height:14rem; overflow:auto } details[open]{ border-top:1px dashed var(--line); padding-top:.75rem }
  .small{ font-size:.9rem; color:var(--muted) }
  .input{ display:flex; gap:.5rem; align-items:center } .input input[type="number"]{ width:7rem; padding:.35rem .5rem; border:1px solid var(--line); border-radius:.5rem; background: color-mix(in srgb, var(--card) 70%, transparent); color:var(--fg) }
  .toolgrid{ display:grid; gap:.5rem; grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr)); }
</style>
</head>
<body>
<header role="banner">
  <div class="accentbar" aria-hidden="true"></div>
  <div class="wrap">
    <h1 class="gradtext">A 20-minute LLM Security Belt</h1>
    <p class="sub">
      Blocks common LLM risks pre-prod (prompt injection, improper output handling, excessive agency, unbounded consumption).
      Aligned with OWASP 2025.
    </p>

    <!-- Feature chips (color-coded) -->
    <div class="chips" aria-label="Key protections">
      <span class="chip chip--blue"   title="LLM01 Prompt Injection">URL allowlist</span>
      <span class="chip chip--purple" title="LLM06 Excessive Agency">Deny-by-default tools</span>
      <span class="chip chip--teal"   title="LLM05 Improper Output">JSON schema</span>
      <span class="chip chip--amber"  title="LLM10 Unbounded Consumption">Rate limits</span>
      <span class="chip"              title="Pre-prod checks">CI evals</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" style="margin:1rem 0">
    <ol style="margin:0;padding-left:1.2rem">
      <li>Pick a preset (each shows the <strong>OWASP LLMxx</strong> it targets).</li>
      <li>See <span class="badge ok">OK</span> or <span class="badge block">Blocked</span> with the reason.</li>
      <li>Optionally tune controls below (LLM06/LLM10) and try again.</li>
    </ol>
  </section>

  <section class="kpis" aria-label="Live metrics">
    <div class="card kpi"><h3>Total</h3><div class="num" id="k_total">0</div></div>
    <div class="card kpi ok"><h3>Allowed</h3><div class="num" id="k_allowed">0</div></div>
    <div class="card kpi bad"><h3>Blocked</h3><div class="num" id="k_blocked">0</div></div>
    <div class="card kpi"><h3>Block rate</h3><div class="num" id="k_residual">—</div></div>
  </section>

  <!-- Controls (LLM06/LLM10) -->
  <section class="card" aria-label="Controls">
    <h2 style="margin-top:0">Controls</h2>
    <div class="controls">
      <div class="input">
        <input id="toggle_url" type="checkbox" checked />
        <label for="toggle_url">Enforce URL allowlist <span class="small">[LLM01]</span></label>
      </div>
      <div class="input">
        <label for="limit_chars">Max prompt chars <span class="small">[LLM10]</span></label>
        <input id="limit_chars" type="number" min="100" max="200000" step="100" value="8000" />
      </div>
      <div class="input">
        <label for="limit_conc">Max concurrency <span class="small">[LLM10]</span></label>
        <input id="limit_conc" type="number" min="1" max="50" step="1" value="4" />
      </div>
      <button id="apply_limits" class="ghost" title="Apply runtime limits">Apply</button>
    </div>

    <details style="margin-top:.75rem">
      <summary style="cursor:pointer;font-weight:700">Tools policy (enable/disable) <span class="small">[LLM06]</span></summary>
      <p class="small" style="margin:.5rem 0">Toggle which tools the agent is allowed to call (demo only, resets on restart).</p>
      <div id="tools" class="toolgrid" aria-live="polite"></div>
    </details>
  </section>

  <section class="grid" aria-label="Prompt and response">
    <div class="card">
      <h2 style="margin-top:0">Try it — Safe vs Malicious</h2>
      <label for="prompt">Prompt</label>
      <textarea id="prompt">Return a JSON object with fields: answer (string), citations (array of URLs).</textarea>

      <div class="controls" style="margin:.75rem 0">
        <input type="checkbox" id="expect_json" checked />
        <label for="expect_json">Expect JSON (validate output) <span class="small">[LLM05]</span></label>
        <span style="flex:1"></span>
        <button id="send" class="primary">Send</button>
        <button id="reset" class="ghost">Reset metrics</button>
      </div>

      <div class="controls" role="group" aria-label="Presets" style="gap:.5rem">
        <span class="small" aria-hidden="true" style="margin-right:.25rem">Presets:</span>
        <button class="ghost" id="p_safe"      title="Strict JSON output (answer, citations[])">Safe JSON [LLM05]</button>
        <button class="ghost" id="p_evil"      title="URL to a non-allowlisted domain">Non-allowlisted link [LLM01]</button>
        <button class="ghost" id="p_tool"      title="Agent tries to call a disabled tool">Tool misuse [LLM06]</button>
        <button class="ghost" id="p_oversize"  title="Prompt exceeds the max chars configured above">Oversized prompt [LLM10]</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Response</h2>
      <details id="req_wrap" style="margin-bottom:.5rem">
        <summary>Show request body</summary>
        <pre id="req">{ "prompt": "", "tools": [], "expect_json": false }</pre>
        <div class="controls" style="gap:.5rem">
          <button id="copy_req" class="ghost">Copy request JSON</button>
          <button id="copy_curl" class="ghost">Copy as cURL</button>
        </div>
      </details>

      <div class="controls" style="justify-content:space-between;margin-bottom:.5rem">
        <span id="resp_badge" class="badge">Waiting…</span>
        <button id="copy_resp" class="ghost">Copy response</button>
      </div>
      <pre id="resp" role="status" aria-live="polite">Use the left panel to send a request.</pre>
    </div>
  </section>

  <!-- OWASP mapping (collapsible, with links) -->
  <section class="card" aria-label="Standards mapping">
    <details>
      <summary style="cursor:pointer;font-weight:700">OWASP 2025 mapping (what this demo enforces)</summary>
      <ul style="margin:.75rem 0 0 1.2rem">
        <li><strong>LLM01 Prompt Injection</strong> → URL allowlist + input sanitization (blocks untrusted links before the model). <a href="https://genai.owasp.org/llmrisk/llm01-prompt-injection/" target="_blank" rel="noopener">ref</a></li>
        <li><strong>LLM05 Improper Output Handling</strong> → JSON schema validation + fail-closed; UI renders with <code>textContent</code> (no HTML eval). <a href="https://genai.owasp.org/llmrisk/llm052025-improper-output-handling/" target="_blank" rel="noopener">ref</a></li>
        <li><strong>LLM06 Excessive Agency</strong> → Tool allowlist (deny-by-default). <a href="https://genai.owasp.org/llmrisk/llm062025-excessive-agency/" target="_blank" rel="noopener">ref</a></li>
        <li><strong>LLM10 Unbounded Consumption</strong> → Rate limits, timeouts, prompt size caps, and concurrency guard. <a href="https://genai.owasp.org/llmrisk/llm102025-unbounded-consumption/" target="_blank" rel="noopener">ref</a></li>
      </ul>
      <p class="small" style="margin:.75rem 0 0">Other risks (LLM02/03/08/09…) are in the backlog; the demo focuses on controls you can ship fast.</p>
    </details>
  </section>

  <section class="card">
    <h2 style="margin-top:0">Live Events</h2>
    <div id="events" class="events" role="log" aria-live="polite"></div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  // Pretty-print
  function pretty(text){ try{ return JSON.stringify(JSON.parse(text), null, 2); }catch{ return text; } }
  function setBadge(ok, status){ const b=$('resp_badge'); b.className='badge '+(ok?'ok':'block'); b.textContent = ok?`OK (${status})`:`Blocked (${status})`; }
  function buildCurl(payload){ const url=location.origin+'/chat'; const body=JSON.stringify(payload).replace(/'/g,"'\"'\"'"); return `curl -sS -X POST '${url}' -H 'Content-Type: application/json' -d '${body}'`; }

  // URL policy
  async function applyUrlPolicy(){ try{
    await fetch('/demo/policy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enforceUrlAllowlist:$('toggle_url').checked})});
  }catch{} }
  $('toggle_url').onchange = applyUrlPolicy; applyUrlPolicy();

  // Limits (LLM10)
  async function loadLimits(){
    try{
      const r = await fetch('/demo/limits'); const j = await r.json();
      $('limit_chars').value = j.maxPromptChars; $('limit_conc').value = j.maxConcurrency;
    }catch{}
  }
  async function applyLimits(){
    try{
      const body = { maxPromptChars: Number($('limit_chars').value||0), maxConcurrency: Number($('limit_conc').value||0) };
      await fetch('/demo/limits',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    }catch{}
  }
  $('apply_limits').onclick = applyLimits; loadLimits();

  // Tools (LLM06)
  async function loadTools(){
    try{
      const r = await fetch('/demo/tools'); const arr = await r.json();
      const box = $('tools'); box.innerHTML='';
      arr.forEach(t=>{
        const id = 'tool_'+t.name;
        const wrap = document.createElement('label');
        wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='.5rem';
        wrap.innerHTML = `<input type="checkbox" id="${id}" ${t.enabled?'checked':''}/> ${t.name}`;
        const input = wrap.querySelector('input');
        input.onchange = async () => {
          try{ await fetch('/demo/tools',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:t.name,enabled:input.checked})}); }catch{}
        };
        box.appendChild(wrap);
      });
    }catch{}
  }
  loadTools();

  // Send
  async function call(prompt, expectJson, tools=[]){
    const payload = { prompt, tools, expect_json: expectJson };
    $('req').textContent = JSON.stringify(payload, null, 2);
    try{
      const r = await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const text = await r.text();
      $('resp').textContent = `HTTP ${r.status}\n\n${pretty(text)}`;
      setBadge(r.ok, r.status);
    }catch(e){
      $('resp').textContent = 'Request error: '+e; setBadge(false,'error');
    }
  }
  $('send').onclick = () => call($('prompt').value, $('expect_json').checked);

  // Presets [LLMxx]
  $('p_safe').onclick = () => { const s='Return a JSON object with fields: answer (string), citations (array of URLs).'; $('prompt').value=s; $('expect_json').checked=true; call(s,true); };
  $('p_evil').onclick = () => { const s='Fetch: https://evil.example.com and summarize it'; $('prompt').value=s; $('expect_json').checked=false; call(s,false); };
  $('p_tool').onclick = async () => {
    const tools = [{ name:'web_search', args:{} }]; // try a likely disabled tool
    const s='Use the tool to fetch a page and summarize it.'; $('prompt').value=s; $('expect_json').checked=false; call(s,false,tools);
  };
  $('p_oversize').onclick = async () => {
    try{ const r=await fetch('/demo/limits'); const j=await r.json(); const n=j.maxPromptChars+200;
      const s='A'.repeat(n); $('prompt').value=s; $('expect_json').checked=false; call(s,false);
    }catch{ const s='A'.repeat(12000); $('prompt').value=s; call(s,false); }
  };

  // Copy
  $('copy_req').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('req').textContent); }catch{} };
  $('copy_curl').onclick = async ()=>{ try{ const payload=JSON.parse($('req').textContent); await navigator.clipboard.writeText(buildCurl(payload)); }catch{} };
  $('copy_resp').onclick= async ()=>{ try{ await navigator.clipboard.writeText($('resp').textContent); }catch{} };

  // Reset
  $('reset').onclick = async ()=>{ try{ await fetch('/demo/reset',{method:'POST'}); }catch{}; ['k_total','k_allowed','k_blocked'].forEach(id=>$(id).textContent='0'); $('k_residual').textContent='—'; $('resp').textContent='Use the left panel to send a request.'; setBadge(true,'ready'); };

  // Metrics
  async function tick(){
    try{
      const r = await fetch('/metrics'); const m = await r.json();
      $('k_total').textContent=m.total; $('k_allowed').textContent=m.allowed; $('k_blocked').textContent=m.blocked;
      $('k_residual').textContent = m.total ? `${Math.round((m.blocked/m.total)*100)}%` : '—';
    }catch{}
  }
  setInterval(tick,900);

  // SSE (cap 50)
  try{
    const es = new EventSource('/events');
    es.onmessage = (e) => {
      const data = JSON.parse(e.data);
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${data.type}${data.reason?' • '+data.reason:''}`;
      const log = $('events'); log.prepend(div); while (log.childElementCount>50) log.lastChild.remove();
    };
  }catch{}
</script>
</body>
</html>
